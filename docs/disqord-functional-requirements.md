# DisQord 機能要件定義書

## 概要

DisQordは、Discord上でLLMと会話できるBotである。Twitter/XのGrokのように、メンションで呼び出して対話する。

- **Bot名**: DisQord
- **LLMプロバイダ**: [OpenRouter](https://openrouter.ai/docs/llms.txt)

---

## v1.0 機能要件

### 1. 呼び出し方法

| 方式 | 対応状況 | 備考 |
|------|----------|------|
| メンション | 対応 | `@DisQord 質問` で呼び出し |
| スラッシュコマンド | 対応 | 設定・ヘルプ用途のみ |
| DM | 非対応 | Guild内のみで動作 |
| リプライ継続 | 非対応 | v2以降で検討 |

### 2. 会話コンテキスト

- **方式**: 単発応答（毎回リセット）
- 過去の会話履歴は保持しない

### 3. モデル選択

- Guild単位でデフォルトモデルを設定可能
- スラッシュコマンドで変更

### 4. 権限・アクセス制御

| 対象 | 権限 |
|------|------|
| Bot利用 | 全員可能 |
| 設定変更 | 全員可能 |

### 5. レート制限

- Bot側での独自制限は設けない
- OpenRouter側のレート制限に従う
- 429エラー受信時は `X-RateLimit-Reset` ヘッダーを参照し、リセット時刻までリクエストを抑制

**OpenRouterレート制限仕様**:

- 429エラー時のレスポンスヘッダー:
  - `X-RateLimit-Limit`: 制限値
  - `X-RateLimit-Remaining`: 残り回数
  - `X-RateLimit-Reset`: リセット時刻（UNIXタイムスタンプ、ミリ秒）

### 6. 応答形式

| 項目 | 仕様 |
|------|------|
| 送信方式 | 一括送信 |
| 長文対応 | 2000文字を超える場合は複数メッセージに分割 |

### 7. エラーハンドリング

- 詳細エラーメッセージを表示
- エラー種別を区別して通知（レート制限、モデルエラー、接続エラー等）

※v1は開発チーム向けリリースのため詳細表示。将来的に一般ユーザー向け簡略表示を追加。

### 8. スラッシュコマンド一覧

| コマンド | 説明 |
|----------|------|
| `/disqord help` | 使い方を表示 |
| `/disqord status` | Botのステータス（OpenRouter残高等）を表示 |
| `/disqord model current` | 現在設定されているモデルを表示 |
| `/disqord model set <model>` | Guildのデフォルトモデルを変更 |
| `/disqord model list` | OpenRouterのモデル一覧ページへ誘導 |

---

## v2以降 将来機能

### 会話・コンテキスト関連

| 機能 | 説明 |
|------|------|
| リプライ継続 | Botへのリプライで会話を継続 |
| コンテキスト保持 | スレッド内: 全メッセージ保持 / チャンネル内: 直近n件保持 |
| OpenProvence連携 | ベクトル検索の代わりにOpenProvenceでリランクし、関連メッセージのみをコンテキストに含める |

### 設定関連

| 機能 | 説明 |
|------|------|
| 階層別モデル設定 | Guild / Channel / User 単位でモデル設定可能 |
| カスタムプロンプト | Guild / Channel / User 単位で設定可能。マージ方式（Guild → Channel → User の順で結合）。モーダルUIで編集、現在値をデフォルト表示 |
| チャンネル制限 | 特定チャンネルのみでBotを有効化 |
| 管理権限ロール指定 | 設定変更権限を特定ロールに限定 |

### 反応モード設定

| 場所 | デフォルト動作 | 設定で変更可能 |
|------|----------------|----------------|
| チャンネル | メンションのみ反応 | 全発言に反応 |
| スレッド | 全発言に反応 | メンションのみ反応 |

### 運用関連

| 機能 | 説明 |
|------|------|
| リリースノート配信 | GitHub Releases連携。新バージョンリリース時に各Guildへ通知。Guild単位で配信可否を設定可能 |
| 簡略エラー表示 | 一般ユーザー向けに必要最低限の情報のみ表示 |

### モデル選択UI改善

| 機能 | 説明 |
|------|------|
| Select Menu/Modalでモデル選択 | `/disqord model set` 実行時にSelect Menuで候補表示。Modalで検索キーワード入力後、フィルタリングされた候補から選択 |
| モデル一覧キャッシュ | OpenRouter APIへのモデル一覧取得をキャッシュ（TTL: 5-10分）。Select Menu表示のたびにAPI呼び出しを避ける |
| モデル検索/フィルタリング | キャッシュされたモデル一覧から検索。Select Menuの25件制限に対応 |

### コード品質・保守性

| 機能 | 説明 |
|------|------|
| メッセージ文字列の分離 | コマンド応答メッセージを別ファイルに切り出し。i18n対応の土台、Embed化と同時に検討 |

---

## 参考情報

### OpenProvence

コンテキスト保持の将来実装で使用予定のリランカー。

- リポジトリ: <https://github.com/hotchpotch/open_provence>
- モデル: <https://huggingface.co/hotchpotch/open-provence-reranker-v1>
- 紹介記事: <https://secon.dev/entry/2025/10/31/100000-open-provence-release/>

### Discord APIレート制限

メッセージ編集のレート制限（ストリーミング風表示を将来検討する場合の参考）:

- グローバル: 50リクエスト/10秒
- サーバーごと: 5リクエスト/5秒
- メッセージの作成・編集両方に適用

---

## 更新履歴

| 日付 | バージョン | 内容 |
|------|------------|------|
| 2025-11-26 | 1.0 | 初版作成 |
