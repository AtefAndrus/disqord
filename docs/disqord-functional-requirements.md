# DisQord 機能要件定義書

## 概要

DisQordは、Discord上でLLMと会話できるBotである。Twitter/XのGrokのように、メンションで呼び出して対話する。

- **Bot名**: DisQord
- **LLMプロバイダ**: [OpenRouter](https://openrouter.ai/docs/llms.txt)

---

## v1.0 機能要件

### 1. 呼び出し方法

| 方式 | 対応状況 | 備考 |
| ------ | ---------- | ------ |
| メンション | 対応 | `@DisQord 質問` で呼び出し |
| スラッシュコマンド | 対応 | 設定・ヘルプ用途のみ |
| DM | 非対応 | Guild内のみで動作 |
| リプライ継続 | 非対応 | v2以降で検討 |

### 2. 会話コンテキスト

- **方式**: 単発応答（毎回リセット）
- 過去の会話履歴は保持しない

### 3. モデル選択

- Guild単位でデフォルトモデルを設定可能
- スラッシュコマンドで変更

### 4. 権限・アクセス制御

| 対象 | 権限 |
| ------ | ------ |
| Bot利用 | 全員可能 |
| 設定変更 | 全員可能 |

### 5. レート制限

- Bot側での独自制限は設けない
- OpenRouter側のレート制限に従う
- 429エラー受信時は `X-RateLimit-Reset` ヘッダーを参照し、リセット時刻までリクエストを抑制

**OpenRouterレート制限仕様**:

- 429エラー時のレスポンスヘッダー:
  - `X-RateLimit-Limit`: 制限値
  - `X-RateLimit-Remaining`: 残り回数
  - `X-RateLimit-Reset`: リセット時刻（UNIXタイムスタンプ、ミリ秒）

### 6. 応答形式

| 項目 | 仕様 |
| ------ | ------ |
| 送信方式 | 一括送信 |
| 長文対応 | 2000文字を超える場合は複数メッセージに分割 |

### 7. エラーハンドリング

- 詳細エラーメッセージを表示
- エラー種別を区別して通知（レート制限、モデルエラー、接続エラー等）

※v1は開発チーム向けリリースのため詳細表示。将来的に一般ユーザー向け簡略表示を追加。

### 8. スラッシュコマンド一覧

| コマンド | 説明 |
| ---------- | ------ |
| `/disqord help` | 使い方を表示 |
| `/disqord status` | Botのステータス（OpenRouter残高等）を表示 |
| `/disqord model current` | 現在設定されているモデルを表示 |
| `/disqord model set <model>` | Guildのデフォルトモデルを変更 |
| `/disqord model list` | OpenRouterのモデル一覧ページへ誘導 |

---

## v1.0.1 機能要件

### 運用改善

| 機能 | 説明 |
| ------ | ------ |
| Health Check | HTTPヘルスエンドポイント（`/health`）を公開。Discordクライアント接続状態を確認可能 |

### UX改善

| 機能 | 説明 |
| ------ | ------ |
| Typing Indicator継続 | LLM応答待機中、8秒間隔で`sendTyping()`を呼び出し、「入力中...」表示を維持 |
| URL埋め込み抑制 | `/disqord model list`でOpenRouter URLのプレビューを非表示（`<URL>`形式） |

---

## v1.1.0 機能要件

### 無料モデル限定機能

| 機能 | 説明 |
| ------ | ------ |
| 無料モデル判定 | OpenRouter APIの`pricing`フィールドで判定（`prompt === "0" && completion === "0"`） |
| Guild単位設定 | `freeModelsOnly`フラグでGuild内を無料モデルのみに制限 |
| モデル一覧キャッシュ | 無料モデル一覧をキャッシュ（TTL: 5-10分）、API呼び出し削減 |

### ユーザ向けエラー表示

エラー種別に応じた分かりやすいメッセージをユーザーに表示する。技術的詳細はログのみに出力。

| エラー種別 | HTTPステータス | ユーザー向けメッセージ |
| ---------- | -------------- | ---------------------- |
| レート制限 | 429 | 「リクエスト制限に達しました。{N}秒後に再度お試しください。」 |
| クレジット不足 | 402 | 「API残高が不足しています。管理者にお問い合わせください。」 |
| コンテンツモデレーション | 403 | 「入力内容が制限されました。表現を変えてお試しください。」 |
| モデル利用不可 | 502/503 | 「モデルが一時的に利用できません。しばらくしてから再度お試しください。」 |
| 認証エラー | 401 | 「Botの設定に問題があります。管理者にお問い合わせください。」 |
| タイムアウト | 408 | 「応答に時間がかかりすぎています。短いメッセージでお試しください。」 |
| 不正リクエスト | 400 | 「リクエストに問題があります。入力内容を確認してください。」 |
| 不明エラー | その他 | 「予期しないエラーが発生しました。問題が続く場合は管理者にお問い合わせください。」 |

### リリースノート配信

GitHub Releaseの公開をトリガーに、登録済みの全Guildへリリースノートを配信する。

| 機能 | 説明 |
| ------ | ------ |
| 通知方式 | GitHub Webhook → Bot HTTPエンドポイント（Cloudflare Tunnel経由） |
| 配信対象 | `release_channel_id`が設定されている全Guild |
| 配信形式 | Embed形式（タイトル、バージョン、リリースノート本文、GitHubリンク） |
| イベント | `release`イベントの`published`アクションのみ |
| 署名検証 | `X-Hub-Signature-256`ヘッダーでHMAC-SHA256検証 |

### 追加コマンド

| コマンド | 説明 |
| ---------- | ------ |
| `/disqord config free-only <on\|off>` | Guildの無料モデル限定設定を切り替え |
| `/disqord config release-channel <channel>` | リリースノート配信先チャンネルを設定 |
| `/disqord config release-channel off` | リリースノート配信を無効化 |

---

## v2以降 将来機能

### 会話・コンテキスト関連

| 機能 | 説明 |
| ------ | ------ |
| リプライ継続 | Botへのリプライで会話を継続 |
| コンテキスト保持 | スレッド内: 全メッセージ保持 / チャンネル内: 直近n件保持 |
| OpenProvence連携 | ベクトル検索の代わりにOpenProvenceでリランクし、関連メッセージのみをコンテキストに含める |

### 設定関連

| 機能 | 説明 |
| ------ | ------ |
| 階層別モデル設定 | Guild / Channel / User 単位でモデル設定可能 |
| カスタムプロンプト | Guild / Channel / User 単位で設定可能。マージ方式（Guild → Channel → User の順で結合）。モーダルUIで編集、現在値をデフォルト表示 |
| チャンネル制限 | 特定チャンネルのみでBotを有効化 |
| 管理権限ロール指定 | 設定変更権限を特定ロールに限定 |

### 反応モード設定

| 場所 | デフォルト動作 | 設定で変更可能 |
| ------ | ---------------- | ---------------- |
| チャンネル | メンションのみ反応 | 全発言に反応 |
| スレッド | 全発言に反応 | メンションのみ反応 |

### LLM機能拡張

| 機能 | 説明 |
| ------ | ------ |
| Web Search | OpenRouter `:online` サフィックスでWeb検索付き応答。注意: 無料モデルでも追加費用発生（Exa検索: 最大$0.02/リクエスト） |
| 複数モデル並列回答 | Body Builder（`openrouter/bodybuilder`）でリクエスト生成し、`Promise.all()`で並列実行。複数モデルの回答を比較表示 |

### モデル選択UI改善

| 機能 | 説明 |
| ------ | ------ |
| Select Menu/Modalでモデル選択 | `/disqord model set` 実行時にSelect Menuで候補表示。Modalで検索キーワード入力後、フィルタリングされた候補から選択 |
| モデル一覧キャッシュ | OpenRouter APIへのモデル一覧取得をキャッシュ（TTL: 5-10分）。Select Menu表示のたびにAPI呼び出しを避ける |
| モデル検索/フィルタリング | キャッシュされたモデル一覧から検索。Select Menuの25件制限に対応 |

### コード品質・保守性

| 機能 | 説明 |
| ------ | ------ |
| メッセージ文字列の分離 | コマンド応答メッセージを別ファイルに切り出し。i18n対応の土台、Embed化と同時に検討 |

---

## 参考情報

### OpenProvence

コンテキスト保持の将来実装で使用予定のリランカー。

- リポジトリ: <https://github.com/hotchpotch/open_provence>
- モデル: <https://huggingface.co/hotchpotch/open-provence-reranker-v1>
- 紹介記事: <https://secon.dev/entry/2025/10/31/100000-open-provence-release/>

### Discord APIレート制限

メッセージ編集のレート制限（ストリーミング風表示を将来検討する場合の参考）:

- グローバル: 50リクエスト/10秒
- サーバーごと: 5リクエスト/5秒
- メッセージの作成・編集両方に適用

---

## 更新履歴

| 日付 | バージョン | 内容 |
| ------ | ------------ | ------ |
| 2025-11-26 | 1.0 | 初版作成 |
| 2025-12-19 | 1.1 | v1.0.1/v1.1.0機能要件追加、v2以降にLLM機能拡張追加 |
| 2025-12-19 | 1.2 | v1.0.1にHealth Check機能追加 |
| 2025-12-21 | 1.3 | v1.1.0にユーザ向けエラー表示・リリースノート配信機能を追加 |
