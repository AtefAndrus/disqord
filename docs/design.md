# DisQord è¨­è¨ˆæ›¸

æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€DisQordã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ä»•æ§˜ã€è¨­è¨ˆåˆ¤æ–­ã‚’å®šç¾©ã™ã‚‹ã€‚

å®Ÿè£…ã®é€²æ—ãƒ»ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—ã¯ [progress.md](progress.md) ã‚’å‚ç…§ã€‚

---

## 1. ä»•æ§˜æ¦‚è¦

### 1.1 å‘¼ã³å‡ºã—æ–¹æ³•

| æ–¹å¼ | å¯¾å¿œçŠ¶æ³ | å‚™è€ƒ |
| ---- | -------- | ---- |
| ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ | å¯¾å¿œ | `@DisQord è³ªå•` ã§å‘¼ã³å‡ºã— |
| ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ | å¯¾å¿œ | è¨­å®šãƒ»ãƒ˜ãƒ«ãƒ—ç”¨é€” |
| DM | éå¯¾å¿œ | Guildå†…ã®ã¿ã§å‹•ä½œ |

### 1.2 ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

- **æ–¹å¼**: å˜ç™ºå¿œç­”ï¼ˆæ¯å›ãƒªã‚»ãƒƒãƒˆï¼‰
- éå»ã®ä¼šè©±å±¥æ­´ã¯ä¿æŒã—ãªã„ï¼ˆv1.4.0ã§å¯¾å¿œäºˆå®šï¼‰

### 1.3 ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§

| ã‚³ãƒãƒ³ãƒ‰ | èª¬æ˜ |
| -------- | ---- |
| `/disqord help` | ä½¿ã„æ–¹ã‚’è¡¨ç¤º |
| `/disqord status` | Botã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆOpenRouteræ®‹é«˜ç­‰ï¼‰ã‚’è¡¨ç¤ºã€ãƒœã‚¿ãƒ³ã§è¨­å®šåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ |
| `/disqord model current` | ç¾åœ¨è¨­å®šã•ã‚Œã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¤º |
| `/disqord model set <model>` | Guildã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã‚’å¤‰æ›´ï¼ˆAutocompleteå¯¾å¿œã€æ–°ã—ã„é †ã‚½ãƒ¼ãƒˆã€å¤‰æ›´æ™‚ã«ãƒ¢ãƒ‡ãƒ«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºï¼‰ |
| `/disqord model list` | OpenRouterã®ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸èª˜å° |
| `/disqord model refresh` | ãƒ¢ãƒ‡ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–° |
| `/disqord config free-only <on\|off>` | Guildã®ç„¡æ–™ãƒ¢ãƒ‡ãƒ«é™å®šè¨­å®šã‚’åˆ‡ã‚Šæ›¿ãˆ |
| `/disqord config release-channel [channel]` | ãƒªãƒªãƒ¼ã‚¹ãƒãƒ¼ãƒˆé…ä¿¡å…ˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’è¨­å®šï¼ˆçœç•¥ã§ç„¡åŠ¹åŒ–ï¼‰ |
| `/disqord config llm-details <on\|off>` | LLMè©³ç´°æƒ…å ±è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ |

### 1.4 å¿œç­”å½¢å¼

| é …ç›® | ä»•æ§˜ |
| ---- | ---- |
| é€ä¿¡æ–¹å¼ | ä¸€æ‹¬é€ä¿¡ï¼ˆEmbedå½¢å¼ï¼‰ |
| é•·æ–‡å¯¾å¿œ | 9000ãƒã‚¤ãƒˆå˜ä½ã§åˆ†å‰²ã€æ”¹è¡Œä½ç½®å„ªå…ˆã€è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ†æ•£ï¼ˆãƒšãƒ¼ã‚¸ç•ªå·è¡¨ç¤ºï¼‰ |
| Typingè¡¨ç¤º | LLMå¿œç­”å¾…æ©Ÿä¸­ã€8ç§’é–“éš”ã§ç¶™ç¶šè¡¨ç¤º |
| Embedã‚«ãƒ©ãƒ¼ | ãƒ¢ãƒ‡ãƒ«IDã‹ã‚‰æ±ºå®šè«–çš„ã«è‰²æ±ºå®šï¼ˆFNV-1aãƒãƒƒã‚·ãƒ¥ã€16è‰²ãƒ‘ãƒ¬ãƒƒãƒˆï¼‰ |
| LLMè©³ç´°æƒ…å ± | ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã€ã‚³ã‚¹ãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã€TPSç­‰ã‚’ãƒ•ãƒƒã‚¿ãƒ¼ã«è¡¨ç¤ºï¼ˆON/OFFåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆONï¼‰ |

---

## 2. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Entrypoint                       â”‚
â”‚                   (src/index.ts)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Bot Layer                         â”‚
â”‚         (events, commands, client)                  â”‚
â”‚  - Discord.jsã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†                            â”‚
â”‚  - ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å‡¦ç†                             â”‚
â”‚  - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ãƒ»é€ä¿¡                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Service Layer                       â”‚
â”‚              (src/services/)                        â”‚
â”‚  - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯                                  â”‚
â”‚  - LLMå‘¼ã³å‡ºã—åˆ¶å¾¡                                   â”‚
â”‚  - è¨­å®šç®¡ç†                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    LLM Layer        â”‚ â”‚      Data Layer              â”‚
â”‚  (src/llm/)         â”‚ â”‚   (src/db/)                  â”‚
â”‚  - OpenRouteré€šä¿¡    â”‚ â”‚  - SQLiteæ“ä½œ                â”‚
â”‚  - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç®¡ç†    â”‚ â”‚  - Repository                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | é©ç”¨ç®‡æ‰€ | ç›®çš„ |
| -------- | -------- | ---- |
| Repository | `src/db/repositories/` | ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®æŠ½è±¡åŒ– |
| Service | `src/services/` | ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã‚«ãƒ—ã‚»ãƒ«åŒ– |
| ä¾å­˜æ€§æ³¨å…¥ | ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ | ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã€ç–çµåˆ |

ä¾å­˜æ€§æ³¨å…¥ã¯æ‰‹å‹•ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã‚’æ¡ç”¨ã€‚è©³ç´°ã¯ `src/index.ts` ã‚’å‚ç…§ã€‚

---

## 3. DBã‚¹ã‚­ãƒ¼ãƒ

### 3.1 ç¾è¡Œã‚¹ã‚­ãƒ¼ãƒ

```sql
CREATE TABLE guild_settings (
    guild_id TEXT PRIMARY KEY,
    default_model TEXT NOT NULL DEFAULT 'deepseek/deepseek-r1-0528:free',
    free_models_only INTEGER NOT NULL DEFAULT 0,
    release_channel_id TEXT DEFAULT NULL,
    show_llm_details INTEGER NOT NULL DEFAULT 1,
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
```

å®Ÿè£…: `src/db/schema.ts`

### 3.2 è¨­è¨ˆæ–¹é‡

| é …ç›® | æ–¹é‡ |
| ---- | ---- |
| Discord ID | TEXTå‹ã§ä¿å­˜ï¼ˆJavaScriptã®Numberç²¾åº¦å•é¡Œã‚’å›é¿ï¼‰ |
| ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ— | ISO 8601æ–‡å­—åˆ—ï¼ˆ`datetime('now')`ï¼‰ |
| Boolean | INTEGERå‹ï¼ˆ0/1ï¼‰ã§ä¿å­˜ |
| WALãƒ¢ãƒ¼ãƒ‰ | æœ‰åŠ¹ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šï¼‰ |

---

## 4. ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹è¨­è¨ˆ

ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã¯ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§:

| ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ | ãƒ•ã‚¡ã‚¤ãƒ« |
| ---------------- | -------- |
| å…±é€šå‹ï¼ˆGuildId, ChatMessageç­‰ï¼‰ | `src/types/index.ts` |
| IGuildSettingsRepository | `src/db/repositories/guildSettings.ts` |
| ISettingsService | `src/services/settingsService.ts` |
| IChatService | `src/services/chatService.ts` |
| IModelService | `src/services/modelService.ts` |
| ILLMClient | `src/llm/openrouter.ts` |

---

## 5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¨­è¨ˆ

### 5.1 è¨­è¨ˆæ–¹é‡

- ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹ã§ç¨®åˆ¥ã‚’æ˜ç¢ºåŒ–
- `userMessage` ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æä¾›
- æŠ€è¡“çš„è©³ç´°ã¯ãƒ­ã‚°ã®ã¿ã«å‡ºåŠ›

### 5.2 ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹éšå±¤

```text
Error
  â””â”€ AppError (base)
       â”œâ”€ RateLimitError (429)
       â”œâ”€ InsufficientCreditsError (402)
       â”œâ”€ ModerationError (403)
       â”œâ”€ InvalidModelError (400 + message pattern)
       â”œâ”€ ConfigurationError (400 + message pattern)
       â”œâ”€ ModelUnavailableError (500, 502, 503)
       â”œâ”€ AuthenticationError (401)
       â”œâ”€ TimeoutError (408)
       â”œâ”€ BadRequestError (400)
       â””â”€ UnknownApiError (ãã®ä»–)
```

å®Ÿè£…: `src/errors/index.ts`

### 5.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| ---------- | ---------------------- |
| ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚{N}ç§’å¾Œã«å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ |
| ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆä¸è¶³ | APIæ®‹é«˜ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚ |
| ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ | å…¥åŠ›å†…å®¹ãŒåˆ¶é™ã•ã‚Œã¾ã—ãŸã€‚è¡¨ç¾ã‚’å¤‰ãˆã¦ãŠè©¦ã—ãã ã•ã„ã€‚ |
| ç„¡åŠ¹ãªãƒ¢ãƒ‡ãƒ« | æŒ‡å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚ |
| è¨­å®šã‚¨ãƒ©ãƒ¼ | OpenRouterã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚è¨­å®šURLã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚ |
| ãƒ¢ãƒ‡ãƒ«åˆ©ç”¨ä¸å¯ | ãƒ¢ãƒ‡ãƒ«ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ |
| èªè¨¼ã‚¨ãƒ©ãƒ¼ | Botã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ç®¡ç†è€…ã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚ |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | å¿œç­”ã«æ™‚é–“ãŒã‹ã‹ã‚Šã™ãã¦ã„ã¾ã™ã€‚çŸ­ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãŠè©¦ã—ãã ã•ã„ã€‚ |
| ä¸æ˜ã‚¨ãƒ©ãƒ¼ | äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ |

### 5.4 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã®è¨­è¨ˆ

OpenRouterã®429ã‚¨ãƒ©ãƒ¼ã«ã¯2ç¨®é¡ãŒã‚ã‚‹:

| ç¨®åˆ¥ | èª¬æ˜ | å‹•ä½œ |
|------|------|------|
| ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ« | APIã‚­ãƒ¼ã«å¯¾ã™ã‚‹åˆ¶é™ï¼ˆ`X-RateLimit-Reset`ã‚ã‚Šï¼‰ | ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ãƒ©ã‚°ã§å…¨ãƒ¢ãƒ‡ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ |
| ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ¬ãƒ™ãƒ« | ç‰¹å®šãƒ¢ãƒ‡ãƒ«ã®ã‚¢ãƒƒãƒ—ã‚¹ãƒˆãƒªãƒ¼ãƒ åˆ¶é™ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ï¼‰ | ãƒ•ãƒ©ã‚°ã‚»ãƒƒãƒˆãªã—ã€ä»–ãƒ¢ãƒ‡ãƒ«ä½¿ç”¨å¯ |

### 5.5 ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹è¨­è¨ˆ

| é …ç›® | å‹•ä½œ |
|------|------|
| å˜ä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆéšœå®³ | ä»–ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å½±éŸ¿ã‚’ä¸ãˆãªã„ |
| ã‚¨ãƒ©ãƒ¼å¿œç­”å¤±æ•— | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãƒ­ã‚°ã®ã¿å‡ºåŠ› |
| `unhandledRejection` | ãƒ­ã‚°å‡ºåŠ›ã€ãƒ—ãƒ­ã‚»ã‚¹ç¶™ç¶š |
| `uncaughtException` | ãƒ­ã‚°å‡ºåŠ›ã€graceful shutdown |

---

## 6. Webhookå—ä¿¡è¨­è¨ˆ

### 6.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```text
GitHub Release (published)
    â†“ POST + X-Hub-Signature-256
Cloudflare Tunnel
    â†“
Bot HTTPã‚µãƒ¼ãƒãƒ¼ (/webhook/github)
    â†“ ç½²åæ¤œè¨¼
ReleaseNotificationService
    â†“
ç™»éŒ²æ¸ˆã¿å…¨Guild (release_channel_idè¨­å®šã‚ã‚Š)
```

### 6.2 è¨­è¨ˆæ–¹é‡

- ç½²åæ¤œè¨¼: HMAC-SHA256ã€timing-safeæ¯”è¼ƒ
- å‡¦ç†å¯¾è±¡: `release`ã‚¤ãƒ™ãƒ³ãƒˆã®`released`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿
- ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®š: [infrastructure-setup.md](infrastructure-setup.md) ã‚’å‚ç…§

---

## 7. å°†æ¥è¨ˆç”»ï¼ˆè¨­è¨ˆéª¨å­ï¼‰

è©³ç´°è¨­è¨ˆã¯å®Ÿè£…æ™‚ã«æœ¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸è¿½è¨˜ã™ã‚‹ã€‚

### v1.3.4 è¨­å®šä¸Šæ›¸ããƒã‚°ä¿®æ­£

**ç›®çš„**: `setGuildModel`ãŒãƒ¢ãƒ‡ãƒ«å¤‰æ›´æ™‚ã«ä»–ã®è¨­å®šï¼ˆ`releaseChannelId`ç­‰ï¼‰ã‚’nullã§ä¸Šæ›¸ãã™ã‚‹ãƒã‚°ã‚’ä¿®æ­£

---

#### å•é¡Œã®æ¦‚è¦

**ç¾è±¡**: `/disqord model set` å®Ÿè¡Œæ™‚ã«ã€ãƒªãƒªãƒ¼ã‚¹é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«è¨­å®šãŒæ¶ˆå¤±ã™ã‚‹

**æ ¹æœ¬åŸå› **: `settingsService.setGuildModel()` ãŒæ—¢å­˜è¨­å®šã‚’å–å¾—ã›ãšã«éƒ¨åˆ†æ›´æ–°ã‚’å®Ÿè¡Œ

**å½±éŸ¿ç®‡æ‰€**: `src/services/settingsService.ts:40-45`

```typescript
// ç¾è¡Œã‚³ãƒ¼ãƒ‰ï¼ˆãƒã‚°ã‚ã‚Šï¼‰
async setGuildModel(guildId: string, model: string): Promise<GuildSettings> {
  return this.repo.upsert(guildId, {
    guildId,
    defaultModel: model,
    updatedAt: new Date().toISOString(),
  });
}
```

**ãƒã‚°ã®ç™ºç¾ãƒ•ãƒ­ãƒ¼**:

1. `setGuildModel` ãŒ `releaseChannelId` ã‚’å«ã¾ãªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§upsertã‚’å‘¼ã³å‡ºã—
2. `GuildSettingsRepository.upsert` ã§ `settings.releaseChannelId ?? null` ã«ã‚ˆã‚Š `null` ãŒè¨­å®šã•ã‚Œã‚‹
3. `ON CONFLICT DO UPDATE SET release_channel_id = excluded.release_channel_id` ã§æ—¢å­˜å€¤ãŒ `null` ã«ä¸Šæ›¸ã

---

#### ä¿®æ­£æ–¹é‡

**å¤‰æ›´å¯¾è±¡**:

- `src/services/settingsService.ts` - `setGuildModel`ãƒ¡ã‚½ãƒƒãƒ‰ä¿®æ­£

**ä¿®æ­£å†…å®¹**:

```typescript
// ä¿®æ­£å¾Œ
async setGuildModel(guildId: string, model: string): Promise<GuildSettings> {
  const existing = await this.getGuildSettings(guildId);
  return this.repo.upsert(guildId, {
    ...existing,
    defaultModel: model,
    updatedAt: new Date().toISOString(),
  });
}
```

**è¨­è¨ˆãƒ¡ãƒ¢**:

- `setFreeModelsOnly`, `setReleaseChannel` ã¨åŒã˜ãƒ‘ã‚¿ãƒ¼ãƒ³ã«çµ±ä¸€
- æ—¢å­˜è¨­å®šã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã—ã¦ãƒãƒ¼ã‚¸ã™ã‚‹ã“ã¨ã§ã€æœªæŒ‡å®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¸Šæ›¸ãã‚’é˜²æ­¢

---

#### ãƒ†ã‚¹ãƒˆè¿½åŠ 

**å¤‰æ›´å¯¾è±¡**:

- `tests/unit/services/settingsService.test.ts`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:

```typescript
test("æ—¢å­˜è¨­å®šã‚’ç¶­æŒã—ã¤ã¤ãƒ¢ãƒ‡ãƒ«ã‚’æ›´æ–°", async () => {
  const existingSettings = createMockGuildSettings({
    guildId: "guild-123",
    defaultModel: "old-model",
    releaseChannelId: "channel-456",
  });
  (mockRepo.findByGuildId as ReturnType<typeof mock>).mockResolvedValueOnce(existingSettings);

  await settingsService.setGuildModel("guild-123", "new-model");

  expect(mockRepo.upsert).toHaveBeenCalledWith(
    "guild-123",
    expect.objectContaining({
      defaultModel: "new-model",
      releaseChannelId: "channel-456", // ç¶­æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨
    }),
  );
});
```

---

### v1.4.0 å³æ™‚UXæ”¹å–„

**ç›®çš„**: ã™ãã«ä½“æ„Ÿã§ãã‚‹UXå‘ä¸Šï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€åœæ­¢ãƒœã‚¿ãƒ³ã€prefixå‰Šé™¤ã€è‡ªå‹•å¿œç­”ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰

---

#### ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å¯¾å¿œ

**å¤‰æ›´å¯¾è±¡**:

- `src/llm/openrouter.ts` - `stream: true`å¯¾å¿œã€SSEå‡¦ç†
- `src/services/chatService.ts` - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†ã€é€²è¡Œä¸­ãƒªã‚¯ã‚¨ã‚¹ãƒˆè¿½è·¡
- `src/bot/events/messageCreate.ts` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯

**è¨­è¨ˆãƒ¡ãƒ¢**:

**ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨èª²é‡‘**:

- **éã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã‚‚ã‚µãƒ¼ãƒãƒ¼å´ã§å‡¦ç†ç¶™ç¶šã€ãƒ•ãƒ«èª²é‡‘
- **ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆå¯¾å¿œãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼‰**: æ¥ç¶šä¸­æ–­ã§å³åº§ã«å‡¦ç†ãƒ»èª²é‡‘åœæ­¢
- **å¯¾å¿œãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: OpenAIã€Anthropicã€Fireworksã€Cohereã€DeepInfraç­‰20+
- **éå¯¾å¿œãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼**: Googleã€AWS Bedrockã€Groqã€Mistralç­‰20+

**å®Ÿè£…æ–¹å¼**:

1. `Map<messageId, AbortController>` ã§é€²è¡Œä¸­ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿½è·¡
2. SSEã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å—ä¿¡
3. 2ç§’ã”ã¨ã«Discordãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™: 5å›/5ç§’ = 1å›/ç§’ã€ä½™è£•ã‚’æŒã£ã¦2ç§’é–“éš”ï¼‰
4. å®Œäº†æ™‚ã«Mapã‹ã‚‰å‰Šé™¤

**å‚ç…§**:

- [OpenRouter Streaming API](https://openrouter.ai/docs/api/reference/streaming) - `stream: true`ã§SSEæœ‰åŠ¹åŒ–ã€2ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°æ¨å¥¨

---

#### åœæ­¢ãƒœã‚¿ãƒ³

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/events/messageCreate.ts` - åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã€ãƒœã‚¿ãƒ³è¿½åŠ 
- `src/bot/events/interactionCreate.ts` - ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
- `src/services/chatService.ts` - AbortControllerç®¡ç†ã€abort()å‘¼ã³å‡ºã—

**UIè¨­è¨ˆ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å›ç­”ç”Ÿæˆä¸­...               â”‚
â”‚                             â”‚
â”‚ [ğŸ›‘ åœæ­¢]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®Ÿè£…ãƒ•ãƒ­ãƒ¼**:

1. ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³å—ä¿¡â†’åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆã€Œå›ç­”ç”Ÿæˆä¸­...ã€+ ğŸ›‘åœæ­¢ãƒœã‚¿ãƒ³ï¼‰
2. ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é–‹å§‹ã€2ç§’ã”ã¨ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ä¿æŒï¼‰
3. å®Œäº†â†’ãƒœã‚¿ãƒ³å‰Šé™¤ã€æœ€çµ‚å¿œç­”è¡¨ç¤º
4. åœæ­¢ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯â†’AbortController.abort()ã€åœæ­¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**è¨­è¨ˆãƒ¡ãƒ¢**:

- ãƒœã‚¿ãƒ³ã®customIdã«`stop_${messageId}_${timestamp}`ã‚’ä½¿ç”¨
- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¯ä¸è¦ï¼ˆé€²æ—ã¯ä¸æ˜ãªãŸã‚ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:
  - ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒéå¯¾å¿œã®å ´åˆã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«è­¦å‘Šã‚’è¡¨ç¤º
  - æ—¢ã«å®Œäº†ã—ãŸãƒªã‚¯ã‚¨ã‚¹ãƒˆã¸ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯ã‚¨ãƒ©ãƒ¼å¿œç­”

**å‚ç…§**:

- [OpenRouter Streaming API](https://openrouter.ai/docs/api/reference/streaming) - ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯`AbortController`ã§å®Ÿè£…ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã‚ˆã£ã¦å¯¾å¿œçŠ¶æ³ãŒç•°ãªã‚‹
- [discord.js ButtonBuilder](https://discord.js.org/docs/packages/discord.js/14.16.3/ButtonBuilder:Class) - ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½œæˆæ–¹æ³•

---

#### prefixå‰Šé™¤

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/commands/disqord.ts` - ã‚³ãƒãƒ³ãƒ‰åå¤‰æ›´ï¼ˆ`disqord` â†’ ãªã—ï¼‰

**å®Ÿè£…å†…å®¹**:

- `/disqord help` â†’ `/help`
- `/disqord status` â†’ `/status`
- `/disqord model set` â†’ `/model set`
- å…¨ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰`disqord`ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤

**è¨­è¨ˆãƒ¡ãƒ¢**:

- ã‚³ãƒãƒ³ãƒ‰ç™»éŒ²æ™‚ã«`name: "help"`ã®ã‚ˆã†ã«å¤‰æ›´
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç¢ºèªä¸è¦ã€å³åº§ã«é©ç”¨

---

#### è‡ªå‹•å¿œç­”ãƒãƒ£ãƒ³ãƒãƒ«

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - guild_settingsæ‹¡å¼µ
- `src/bot/events/messageCreate.ts` - è‡ªå‹•å¿œç­”åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
- `src/bot/commands/disqord.ts` - `config auto-reply`ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
ALTER TABLE guild_settings ADD COLUMN auto_reply_channels TEXT; -- JSON array
```

**ã‚³ãƒãƒ³ãƒ‰è¨­è¨ˆ**:

```
/config auto-reply add <channel>
  - æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã‚’è‡ªå‹•å¿œç­”ãƒªã‚¹ãƒˆã«è¿½åŠ 
  - ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ã®ä¸¡æ–¹å¯¾å¿œ

/config auto-reply remove <channel>
  - æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã‚’è‡ªå‹•å¿œç­”ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤

/config auto-reply list
  - ç¾åœ¨ã®è‡ªå‹•å¿œç­”ãƒãƒ£ãƒ³ãƒãƒ«ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
```

**å®Ÿè£…å†…å®¹**:

1. **è‡ªå‹•å¿œç­”åˆ¤å®š**:
   - `auto_reply_channels`é…åˆ—ã«å«ã¾ã‚Œã‚‹ãƒãƒ£ãƒ³ãƒãƒ«/ã‚¹ãƒ¬ãƒƒãƒ‰ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä¸è¦
   - Botè‡ªèº«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯å¿œç­”ã—ãªã„
   - ä»–ã®Botã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«ã¯å¿œç­”ã—ãªã„

2. **ã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œ**:
   - è¦ªãƒãƒ£ãƒ³ãƒãƒ«IDãŒ`auto_reply_channels`ã«å«ã¾ã‚Œã‚‹å ´åˆã€ã™ã¹ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§è‡ªå‹•å¿œç­”
   - å€‹åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰IDã‚‚è¿½åŠ å¯èƒ½ï¼ˆå„ªå…ˆåº¦: ã‚¹ãƒ¬ãƒƒãƒ‰ > è¦ªãƒãƒ£ãƒ³ãƒãƒ«ï¼‰

3. **æ¨©é™ç®¡ç†ã¨ã®é–¢ä¿‚**:
   - `allowed_channels`: BotãŒå¿œç­”å¯èƒ½ãªãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ›ãƒ¯ã‚¤ãƒˆãƒªã‚¹ãƒˆï¼ˆåˆ¶é™æ©Ÿèƒ½ï¼‰
   - `auto_reply_channels`: ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä¸è¦ã§è‡ªå‹•å¿œç­”ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆæ‹¡å¼µæ©Ÿèƒ½ï¼‰
   - `auto_reply_channels`ã¯`allowed_channels`ã®ã‚µãƒ–ã‚»ãƒƒãƒˆã§ã‚ã‚‹ã¹ã

**è¨­è¨ˆãƒ¡ãƒ¢**:

```typescript
function shouldAutoReply(message: Message, autoReplyChannels: string[]): boolean {
  if (message.channel.isThread()) {
    return autoReplyChannels.includes(message.channel.id) ||
           autoReplyChannels.includes(message.channel.parentId);
  }
  return autoReplyChannels.includes(message.channel.id);
}
```

**å‚ç…§**:

- [discord.js BaseChannel](https://discord.js.org/docs/packages/discord.js/14.16.3/BaseChannel:Class) - ãƒãƒ£ãƒ³ãƒãƒ«ãƒ»ã‚¹ãƒ¬ãƒƒãƒ‰åˆ¤å®šã«`isThread()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
- [discord.js ThreadChannel](https://discord.js.org/docs/packages/discord.js/14.16.3/ThreadChannel:Class) - `parentId`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¦ªãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å–å¾—

---

### v1.5.0 å¯¾è©±UXæ”¹å–„

**ç›®çš„**: ç›´è¿‘nä»¶ã®ä¼šè©±å±¥æ­´ã‚’LLMã«é€ä¿¡ã—ã€æ–‡è„ˆã‚’ä¿æŒã—ãŸå¯¾è©±ã‚’å®Ÿç¾ã€‚å›ç­”ã®å†ç”Ÿæˆã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†ã«ã‚ˆã‚‹å†ç”Ÿæˆæ©Ÿèƒ½ã‚’è¿½åŠ ã€‚

---

#### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾è©±

**å¤‰æ›´å¯¾è±¡**:

- `src/services/chatService.ts` - Discord APIã‹ã‚‰å±¥æ­´å–å¾—ã€è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¯¾å¿œ
- `src/bot/events/messageCreate.ts` - channelIdæŠ½å‡º
- `src/bot/commands/config.ts` - `context`ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ ï¼ˆå±¥æ­´ä»¶æ•°è¨­å®šï¼‰

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
ALTER TABLE guild_settings ADD COLUMN context_limit INTEGER NOT NULL DEFAULT 5;
```

**å®Ÿè£…æ–¹æ³•**:

```typescript
// ãƒãƒ£ãƒ³ãƒãƒ«ã‹ã‚‰ç›´è¿‘nä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
const messages = await channel.messages.fetch({
  limit: contextLimit * 2 // ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨Botå¿œç­”ã‚’è€ƒæ…®
});

// Botãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨Botå¿œç­”ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const conversationMessages = messages
  .filter(m => m.mentions.has(botId) || m.author.id === botId)
  .reverse() // å¤ã„é †ã«ä¸¦ã³æ›¿ãˆ
  .slice(-contextLimit) // ç›´è¿‘nä»¶ã®ã¿
  .map(m => ({
    role: m.author.id === botId ? 'assistant' : 'user',
    content: m.content.replace(/<@!?\d+>/g, '').trim()
  }));
```

**è¨­è¨ˆãƒ¡ãƒ¢**:

- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 5ä»¶ã€0-20ä»¶è¨­å®šå¯èƒ½
- DBä¸è¦ï¼ˆDiscordãŒçœŸå®Ÿã®æƒ…å ±æºï¼‰
- å‰Šé™¤ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å–å¾—ã§ããªã„ï¼ˆè¨±å®¹ç¯„å›²ï¼‰
- Discord APIãƒ¬ãƒ¼ãƒˆåˆ¶é™: 50ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ç§’ï¼ˆååˆ†ï¼‰
- ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: å…¨ä¼šè©±ã«ä»˜ä¸

---

#### å›ç­”å†ç”Ÿæˆæ©Ÿèƒ½

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - `response_generations`ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
- `src/bot/events/messageCreate.ts` - å†ç”Ÿæˆãƒœã‚¿ãƒ³è¿½åŠ ã€ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
- `src/services/chatService.ts` - å†ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ã€å±¥æ­´ä¿å­˜

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
CREATE TABLE response_generations (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    channel_id TEXT NOT NULL,
    user_message_id TEXT NOT NULL,
    bot_message_id TEXT NOT NULL,
    generation_number INTEGER NOT NULL DEFAULT 1,
    prompt TEXT NOT NULL,
    response TEXT NOT NULL,
    created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX idx_response_user_msg ON response_generations(user_message_id);
```

**UIè¨­è¨ˆ**:

- LLMå¿œç­”ã®ä¸‹ã«ã€ŒğŸ”„ å†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’é…ç½®
- ã‚¯ãƒªãƒƒã‚¯æ™‚ã«åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§æ–°ã—ã„å¿œç­”ã‚’ç”Ÿæˆ
- å‰ã®å¿œç­”ã¯æŠ˜ã‚ŠãŸãŸã¿ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ç§»å‹•ï¼ˆã€Œå‰å›ã®å¿œç­” (ç¬¬Nä¸–ä»£)ã€ï¼‰
- æœ€æ–°ã®å¿œç­”ã¯å¸¸ã«ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«è¡¨ç¤º

**è¨­è¨ˆãƒ¡ãƒ¢**:

- ä¸–ä»£ç•ªå·ã‚’ç®¡ç†ï¼ˆç¬¬1ä¸–ä»£ã€ç¬¬2ä¸–ä»£...ï¼‰
- æœ€å¤§ä¿å­˜ä¸–ä»£æ•°: 5ä¸–ä»£ï¼ˆå¤ã„ã‚‚ã®ã¯å‰Šé™¤ï¼‰
- ãƒœã‚¿ãƒ³ã¯5åˆ†é–“æœ‰åŠ¹ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã¯æ–°è¦ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§å‘¼ã³å‡ºã—ï¼‰

---

#### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç·¨é›†å†ç”Ÿæˆ

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/events/messageUpdate.ts` - æ–°è¦ä½œæˆ
- `src/services/chatService.ts` - ç·¨é›†æ¤œçŸ¥ã€å†ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯

**å®Ÿè£…å†…å®¹**:

1. `messageUpdate`ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç·¨é›†ã‚’æ¤œçŸ¥
2. æœ€æ–°ã®Botå¿œç­”ã‚’æ›´æ–°ï¼ˆå¤ã„å¿œç­”ã¯ä¿æŒã—ãªã„ï¼‰
3. ç·¨é›†ã¯æœ€æ–°ã®å›ç­”ã«å¯¾ã—ã¦ã®ã¿æœ‰åŠ¹ï¼ˆéå»ã®ä¼šè©±ã«ã¯å½±éŸ¿ã—ãªã„ï¼‰

**è¨­è¨ˆãƒ¡ãƒ¢**:

- ç·¨é›†æ¤œçŸ¥ã¯ç„¡åˆ¶é™ï¼ˆæ™‚é–“åˆ¶é™ãªã—ï¼‰
- æœ€æ–°ã®å¿œç­”ã®ã¿ã‚’æ›´æ–°ï¼ˆå±¥æ­´ã®è¤‡é›‘åŒ–ã‚’é¿ã‘ã‚‹ï¼‰
- ä¼šè©±å±¥æ­´ã«ã¯ç·¨é›†å¾Œã®å†…å®¹ã‚’ä¿å­˜

**å‚ç…§**:

- [OpenRouter Chat Completions API](https://openrouter.ai/docs) - `/api/v1/chat/completions`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ä¼šè©±å±¥æ­´ã¯`messages`é…åˆ—ã«è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
- [discord.js Client Events](https://discord.js.org/docs/packages/discord.js/14.16.3/Client:Class) - `messageUpdate`ã‚¤ãƒ™ãƒ³ãƒˆã§ç·¨é›†ã‚’æ¤œçŸ¥
- [discord.js Message.fetch](https://discord.js.org/docs/packages/discord.js/14.16.3/TextChannel:Class#fetch) - `channel.messages.fetch({limit: n})`ã§å±¥æ­´å–å¾—

---

### v1.6.0 è¨­å®šéšå±¤åŒ– + LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ + ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

**ç›®çš„**: Guild/Channel/Userå˜ä½ã§è¨­å®šã‚’ä¸Šæ›¸ãå¯èƒ½ã«ã€LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«æœ€é©åŒ–ã€ã‚«ã‚¹ã‚¿ãƒ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šå¯èƒ½ã«

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - `channel_settings`, `user_settings`ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã€`llm_params`ã‚«ãƒ©ãƒ è¿½åŠ 
- `src/db/repositories/` - æ–°è¦Repositoryè¿½åŠ 
- `src/services/settingsService.ts` - éšå±¤è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯
- `src/services/modelService.ts` - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
- `src/llm/openrouter.ts` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é©ç”¨

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
CREATE TABLE channel_settings (
    channel_id TEXT PRIMARY KEY,
    guild_id TEXT NOT NULL,
    model TEXT,
    system_prompt TEXT,
    llm_params TEXT,  -- JSON: {temperature, top_p, ...}
    FOREIGN KEY (guild_id) REFERENCES guild_settings(guild_id)
);

CREATE TABLE user_settings (
    user_id TEXT PRIMARY KEY,
    model TEXT,
    system_prompt TEXT,
    llm_params TEXT  -- JSON
);

ALTER TABLE guild_settings ADD COLUMN llm_params TEXT;
```

**LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ**:

**Phase 1: ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

1. `/api/v1/models` APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹`default_parameters`ã‚’ä½¿ç”¨
2. `ModelService`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚ã«ä¿å­˜
3. `chatService`ãŒãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦é©ç”¨

**Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå¯èƒ½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

- `/disqord config params set <json>` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§è¨­å®š
- `/disqord config params reset` - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
- `/disqord config params show` - ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º

**ãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯**:

1. ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
2. Guildè¨­å®šã§ãƒãƒ¼ã‚¸
3. Channelè¨­å®šã§ãƒãƒ¼ã‚¸
4. Userè¨­å®šã§ãƒãƒ¼ã‚¸
5. `supported_parameters`ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**å‚ç…§**:

- [OpenRouter Parameters](https://openrouter.ai/docs/api/reference/parameters)
- [OpenRouter Models API](https://openrouter.ai/docs/api/api-reference/models/get-models)

**è¨­è¨ˆãƒ¡ãƒ¢**:

- å„ªå…ˆé †ä½: User > Channel > Guild > Model Default > OpenRouter Default
- NULLå€¤ã¯ä¸Šä½è¨­å®šã‚’ç¶™æ‰¿
- ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ‹’å¦

---

#### ã‚«ã‚¹ã‚¿ãƒ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/commands/disqord.ts` - `prompt`ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
- `src/bot/commands/handlers.ts` - promptãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ 
- `src/services/settingsService.ts` - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—ãƒ»è¨­å®šãƒ­ã‚¸ãƒƒã‚¯
- `src/services/chatService.ts` - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é©ç”¨

**ã‚³ãƒãƒ³ãƒ‰è¨­è¨ˆ**:

```
/disqord prompt set <scope> <prompt>
  - scope: guild | channel | user
  - prompt: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæœ€å¤§2000æ–‡å­—ï¼‰

/disqord prompt show [scope]
  - scopeçœç•¥æ™‚: ç¾åœ¨ã®æœ‰åŠ¹ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºï¼ˆå„ªå…ˆé †ä½é©ç”¨å¾Œï¼‰
  - scopeæŒ‡å®šæ™‚: æŒ‡å®šã‚¹ã‚³ãƒ¼ãƒ—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿è¡¨ç¤º

/disqord prompt reset [scope]
  - scopeçœç•¥æ™‚: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
  - scopeæŒ‡å®šæ™‚: æŒ‡å®šã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
```

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:

```
You are a helpful AI assistant in a Discord server.
- Keep responses concise and clear
- Use Discord-supported markdown only (no H4+, tables, horizontal rules)
- Be respectful and informative
```

**è¨­è¨ˆãƒ¡ãƒ¢**:

- å„ªå…ˆé †ä½: User > Channel > Guild > Default
- NULLå€¤ã¯ä¸Šä½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¶™æ‰¿
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…ˆé ­ã«è¿½åŠ ï¼ˆ`role: "system"`ï¼‰
- æœ€å¤§é•·: 2000æ–‡å­—ï¼ˆDiscordåˆ¶é™ã‚’è€ƒæ…®ï¼‰

**å‚ç…§**:

- [OpenRouter Chat Completions API](https://openrouter.ai/docs) - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯`messages`é…åˆ—ã®æœ€åˆã®è¦ç´ ã¨ã—ã¦`{role: "system", content: "..."}`å½¢å¼ã§é€ä¿¡

---

### v1.6.0 ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ

**ç›®çš„**: Discordç”»åƒæ·»ä»˜ã‚’LLMã«é€ä¿¡ã—ã€ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œãƒ¢ãƒ‡ãƒ«ã§ç”»åƒèªè­˜ã‚’å®Ÿç¾

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/events/messageCreate.ts` - ç”»åƒæ·»ä»˜æ¤œçŸ¥ã€URLæŠ½å‡º
- `src/services/chatService.ts` - ç”»åƒURLã‚’å«ã‚€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- `src/llm/openrouter.ts` - `content: [{type: "image_url"}]`å¯¾å¿œ
- `src/types/index.ts` - `ChatMessage`å‹æ‹¡å¼µ
- `src/utils/modelDetailsFormatter.ts` - ãƒ¢ãƒ€ãƒªãƒ†ã‚£è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼è¿½åŠ 

**å‹æ‹¡å¼µ**:

```typescript
export interface ChatMessage {
  role: "user" | "assistant" | "system";
  content: string | ChatMessageContent[];
}

export type ChatMessageContent =
  | { type: "text"; text: string }
  | { type: "image_url"; image_url: { url: string } };
```

**å®Ÿè£…å†…å®¹**:

1. **ç”»åƒæ·»ä»˜æ¤œçŸ¥**:
   - `message.attachments`ã‹ã‚‰ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆpng, jpg, jpeg, gif, webpï¼‰ã‚’æŠ½å‡º
   - Discord CDN URLã‚’å–å¾—

2. **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡**:
   - ãƒ†ã‚­ã‚¹ãƒˆ + ç”»åƒURLã‚’`content`é…åˆ—ã¨ã—ã¦é€ä¿¡
   - ç”»åƒãŒè¤‡æ•°ã‚ã‚‹å ´åˆã¯ã™ã¹ã¦é€ä¿¡ï¼ˆæœ€å¤§10æšï¼‰

3. **ãƒ¢ãƒ€ãƒªãƒ†ã‚£è¡¨ç¤º**:
   - `/disqord model set`ã§ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œãƒ¢ãƒ‡ãƒ«ã®å ´åˆã€`input_modalities`/`output_modalities`ã‚’è¡¨ç¤º
   - ä¾‹: ã€Œå¯¾å¿œå…¥åŠ›: text, imageã€ã€Œå¯¾å¿œå‡ºåŠ›: textã€

**è¨­è¨ˆãƒ¡ãƒ¢**:

- éãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ¢ãƒ‡ãƒ«ã«ç”»åƒã‚’é€ä¿¡ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ â†’ è­¦å‘Šè¡¨ç¤º
- ç”»åƒURLæœ‰åŠ¹æœŸé™: Discord CDNã¯æ°¸ç¶šçš„ï¼ˆå‰Šé™¤ã•ã‚Œãªã„é™ã‚Šï¼‰
- æœ€å¤§ç”»åƒæ•°: 10æšï¼ˆOpenRouteråˆ¶é™ï¼‰
- ã‚µãƒãƒ¼ãƒˆç”»åƒå½¢å¼: png, jpg, jpeg, gif, webp

**å‚ç…§**:

- [OpenRouter Chat Completions API](https://openrouter.ai/docs) - ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å…¥åŠ›ã¯`messages[].content`ã‚’é…åˆ—ã«ã—ã€`{type: "text", text: "..."}`, `{type: "image_url", image_url: {url: "..."}}`ã‚’å«ã‚ã‚‹
- [discord.js Message.attachments](https://discord.js.org/docs/packages/discord.js/14.16.3/Message:Class#attachments) - `message.attachments`ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç”»åƒURLã‚’å–å¾—ã€`attachment.contentType`ã§ç”»åƒåˆ¤å®š

---

### v1.7.0 Web Search

**ç›®çš„**: LLMã«Webæ¤œç´¢æ©Ÿèƒ½ã‚’ä»˜ä¸ã—ã€æœ€æ–°æƒ…å ±ã‚’å–å¾—å¯èƒ½ã«

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - guild_settingsæ‹¡å¼µ
- `src/services/chatService.ts` - ãƒ¢ãƒ‡ãƒ«IDã«`:online`ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸
- `src/bot/commands/config.ts` - `web-search`ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
ALTER TABLE guild_settings ADD COLUMN web_search_enabled INTEGER NOT NULL DEFAULT 0;
```

**ã‚³ãƒãƒ³ãƒ‰è¨­è¨ˆ**:

```
/config web-search <on|off>
  - ON: ãƒ¢ãƒ‡ãƒ«IDã«`:online`ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è‡ªå‹•ä»˜ä¸
  - OFF: é€šå¸¸ã®ãƒ¢ãƒ‡ãƒ«IDã‚’ä½¿ç”¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
```

**å®Ÿè£…å†…å®¹**:

1. **Web Searchæœ‰åŠ¹åŒ–**:
   - è¨­å®šONã®å ´åˆã€LLMãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒ¢ãƒ‡ãƒ«IDã«`:online`ã‚’è¿½åŠ 
   - ä¾‹: `deepseek/deepseek-r1-0528:free` â†’ `deepseek/deepseek-r1-0528:free:online`

2. **è²»ç”¨è­¦å‘Š**:
   - Web Searchæœ‰åŠ¹åŒ–æ™‚ã«è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
   - ã€ŒWebæ¤œç´¢ã¯è¿½åŠ è²»ç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚è©³ç´°ã¯OpenRouteræ–™é‡‘ãƒšãƒ¼ã‚¸ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ã€

3. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º**:
   - `/status`ã«Web Searchè¨­å®šçŠ¶æ…‹ã‚’è¿½åŠ 

**è¨­è¨ˆãƒ¡ãƒ¢**:

- OpenRouter `:online` ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§æœ‰åŠ¹åŒ–
- è¿½åŠ è²»ç”¨: ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã£ã¦ç•°ãªã‚‹ï¼ˆé€šå¸¸+$0.01ã€œ$0.05/ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰
- å¯¾å¿œãƒ¢ãƒ‡ãƒ«: `:online`ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«å¯¾å¿œã—ã¦ã„ã‚‹ãƒ¢ãƒ‡ãƒ«ã®ã¿

**å‚ç…§**:

- [OpenRouter Chat Completions API](https://openrouter.ai/docs) - Webæ¤œç´¢æœ‰åŠ¹åŒ–: ãƒ¢ãƒ‡ãƒ«IDã«`:online`ã‚µãƒ•ã‚£ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆä¾‹: `model:online`ï¼‰ã€ã¾ãŸã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«`plugins: [{id: "web"}]`ã‚’å«ã‚ã‚‹

---

### v1.8.0 è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ä¸¦åˆ—

**ç›®çš„**: åŒã˜è³ªå•ã‚’è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã«æŠ•ã’ã¦æ¯”è¼ƒã€æœ€é©ãªãƒ¢ãƒ‡ãƒ«é¸æŠã®æ”¯æ´

**å¤‰æ›´å¯¾è±¡**:

- `src/services/chatService.ts` - ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- `src/bot/commands/model.ts` - `compare`ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
- `src/bot/events/messageCreate.ts` - è¤‡æ•°Embedé€ä¿¡ãƒ­ã‚¸ãƒƒã‚¯

**ã‚³ãƒãƒ³ãƒ‰è¨­è¨ˆ**:

```
/model compare <model1> <model2> [model3] [model4]
  - 2ã€œ4ãƒ¢ãƒ‡ãƒ«ã‚’æŒ‡å®š
  - å„ãƒ¢ãƒ‡ãƒ«ã§åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å®Ÿè¡Œ
  - çµæœã‚’åˆ¥ã€…ã®Embedã§è¡¨ç¤º
```

**å®Ÿè£…å†…å®¹**:

1. **ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
   - `Promise.allSettled()`ã§è¤‡æ•°ãƒ¢ãƒ‡ãƒ«ã«ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
   - å„ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’å€‹åˆ¥ã«å‡¦ç†ï¼ˆä¸€éƒ¨å¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶™ç¶šï¼‰

2. **çµæœè¡¨ç¤º**:
   - å„ãƒ¢ãƒ‡ãƒ«ã®å¿œç­”ã‚’åˆ¥ã€…ã®Embedã§è¡¨ç¤º
   - Embedã‚«ãƒ©ãƒ¼ã¯ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«æ±ºå®šè«–çš„ã«æ±ºå®šï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
   - å¤±æ•—ã—ãŸãƒ¢ãƒ‡ãƒ«ã¯ã‚¨ãƒ©ãƒ¼Embedã§è¡¨ç¤º

3. **æ¯”è¼ƒãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼**:
   - ã€Œæ¯”è¼ƒçµæœ: ãƒ¢ãƒ‡ãƒ«A vs ãƒ¢ãƒ‡ãƒ«Bã€
   - å„Embedã®ã‚¿ã‚¤ãƒˆãƒ«ã«ãƒ¢ãƒ‡ãƒ«åã‚’è¡¨ç¤º

**è¨­è¨ˆãƒ¡ãƒ¢**:

- æœ€å¤§4ãƒ¢ãƒ‡ãƒ«åŒæ™‚æ¯”è¼ƒï¼ˆDiscord Embedåˆ¶é™: 10å€‹/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ä½™è£•ã‚’æŒã£ã¦4å€‹ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™è€ƒæ…®: ä¸¦åˆ—ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§åˆ¶é™ã«é”ã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š â†’ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
- è²»ç”¨æ³¨æ„: è¤‡æ•°ãƒ¢ãƒ‡ãƒ«å®Ÿè¡Œã§è²»ç”¨å¢—åŠ  â†’ è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**å‚ç…§**:

- [Promise.allSettled()](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/allSettled)

---

### v1.9.0 è¨­å®šéšå±¤åŒ– + LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ + ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

**ç›®çš„**: Guild/Channel/Userå˜ä½ã§è¨­å®šã‚’ä¸Šæ›¸ãå¯èƒ½ã«ã€LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒ¢ãƒ‡ãƒ«ã”ã¨ã«æœ€é©åŒ–ã€ã‚«ã‚¹ã‚¿ãƒ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¨­å®šå¯èƒ½ã«

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - `channel_settings`, `user_settings`ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã€`llm_params`ã‚«ãƒ©ãƒ è¿½åŠ 
- `src/db/repositories/` - æ–°è¦Repositoryè¿½åŠ 
- `src/services/settingsService.ts` - éšå±¤è§£æ±ºãƒ­ã‚¸ãƒƒã‚¯
- `src/services/modelService.ts` - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
- `src/llm/openrouter.ts` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿é©ç”¨

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
CREATE TABLE channel_settings (
    channel_id TEXT PRIMARY KEY,
    guild_id TEXT NOT NULL,
    model TEXT,
    system_prompt TEXT,
    llm_params TEXT,  -- JSON: {temperature, top_p, ...}
    FOREIGN KEY (guild_id) REFERENCES guild_settings(guild_id)
);

CREATE TABLE user_settings (
    user_id TEXT PRIMARY KEY,
    model TEXT,
    system_prompt TEXT,
    llm_params TEXT  -- JSON
);

ALTER TABLE guild_settings ADD COLUMN llm_params TEXT;
ALTER TABLE guild_settings ADD COLUMN system_prompt TEXT;
```

**LLMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­è¨ˆ**:

**Phase 1: ãƒ¢ãƒ‡ãƒ«ã”ã¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

1. `/api/v1/models` APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã¾ã‚Œã‚‹`default_parameters`ã‚’ä½¿ç”¨
2. `ModelService`ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ™‚ã«ä¿å­˜
3. `chatService`ãŒãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦é©ç”¨

**Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šå¯èƒ½ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:

- `/config params set <json>` - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§è¨­å®š
- `/config params reset` - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
- `/config params show` - ç¾åœ¨ã®è¨­å®šã‚’è¡¨ç¤º

**ãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯**:

1. ãƒ¢ãƒ‡ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
2. Guildè¨­å®šã§ãƒãƒ¼ã‚¸
3. Channelè¨­å®šã§ãƒãƒ¼ã‚¸
4. Userè¨­å®šã§ãƒãƒ¼ã‚¸
5. `supported_parameters`ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**å‚ç…§**:

- [OpenRouter API Documentation](https://openrouter.ai/docs) - ãƒãƒ£ãƒƒãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆtemperatureã€top_pãªã©ï¼‰ã¯`/api/v1/chat/completions`ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹
- [OpenRouter Models API](https://openrouter.ai/docs) - `/api/v1/models`ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§`default_parameters`ã¨`supported_parameters`ã‚’å–å¾—

**è¨­è¨ˆãƒ¡ãƒ¢**:

- å„ªå…ˆé †ä½: User > Channel > Guild > Model Default > OpenRouter Default
- NULLå€¤ã¯ä¸Šä½è¨­å®šã‚’ç¶™æ‰¿
- ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§æ‹’å¦

---

#### ã‚«ã‚¹ã‚¿ãƒ ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

**å¤‰æ›´å¯¾è±¡**:

- `src/bot/commands/prompt.ts` - `prompt`ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 
- `src/bot/commands/handlers.ts` - promptãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ 
- `src/services/settingsService.ts` - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå–å¾—ãƒ»è¨­å®šãƒ­ã‚¸ãƒƒã‚¯
- `src/services/chatService.ts` - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®é©ç”¨

**ã‚³ãƒãƒ³ãƒ‰è¨­è¨ˆ**:

```
/prompt set <scope> <prompt>
  - scope: guild | channel | user
  - prompt: ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆæœ€å¤§2000æ–‡å­—ï¼‰

/prompt show [scope]
  - scopeçœç•¥æ™‚: ç¾åœ¨ã®æœ‰åŠ¹ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¡¨ç¤ºï¼ˆå„ªå…ˆé †ä½é©ç”¨å¾Œï¼‰
  - scopeæŒ‡å®šæ™‚: æŒ‡å®šã‚¹ã‚³ãƒ¼ãƒ—ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ã¿è¡¨ç¤º

/prompt reset [scope]
  - scopeçœç•¥æ™‚: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
  - scopeæŒ‡å®šæ™‚: æŒ‡å®šã‚¹ã‚³ãƒ¼ãƒ—ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆ
```

**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**:

```
You are a helpful AI assistant in a Discord server.
- Keep responses concise and clear
- Use Discord-supported markdown only (no H4+, tables, horizontal rules)
- Be respectful and informative
```

**è¨­è¨ˆãƒ¡ãƒ¢**:

- å„ªå…ˆé †ä½: User > Channel > Guild > Default
- NULLå€¤ã¯ä¸Šä½ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç¶™æ‰¿
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å…¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å…ˆé ­ã«è¿½åŠ ï¼ˆ`role: "system"`ï¼‰
- æœ€å¤§é•·: 2000æ–‡å­—ï¼ˆDiscordåˆ¶é™ã‚’è€ƒæ…®ï¼‰

**å‚ç…§**:

- [OpenRouter Chat API](https://openrouter.ai/docs/api-reference) - ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯`messages`é…åˆ—ã®æœ€åˆã«`{role: "system", content: "..."}`ã¨ã—ã¦é€ä¿¡

---

### v1.10.0 æ¨©é™ç®¡ç† + AIæ”¹å–„

**ç›®çš„**: Botåˆ©ç”¨ã‚’ç‰¹å®šãƒãƒ£ãƒ³ãƒãƒ«/ãƒ­ãƒ¼ãƒ«ã«åˆ¶é™

**å¤‰æ›´å¯¾è±¡**:

- `src/db/schema.ts` - guild_settingsæ‹¡å¼µ
- `src/bot/events/messageCreate.ts` - æ¨©é™ãƒã‚§ãƒƒã‚¯è¿½åŠ 
- `src/bot/commands/disqord.ts` - configã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰è¿½åŠ 

**DBã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**:

```sql
ALTER TABLE guild_settings ADD COLUMN allowed_channels TEXT;  -- JSON array
ALTER TABLE guild_settings ADD COLUMN admin_role_id TEXT;
```

**è¨­è¨ˆãƒ¡ãƒ¢**:

- `allowed_channels`: NULL=å…¨ãƒãƒ£ãƒ³ãƒãƒ«è¨±å¯ã€é…åˆ—=æŒ‡å®šãƒãƒ£ãƒ³ãƒãƒ«ã®ã¿
- `admin_role_id`: è¨­å®šå¤‰æ›´æ¨©é™ã‚’æŒã¤ãƒ­ãƒ¼ãƒ«

**å‚ç…§**:

- [discord.js PermissionsBitField](https://discord.js.org/docs/packages/discord.js/14.16.3/PermissionsBitField:Class) - `member.permissions.has()`ã§æ¨©é™ãƒã‚§ãƒƒã‚¯
- [discord.js GuildMember](https://discord.js.org/docs/packages/discord.js/14.16.3/GuildMember:Class) - `member.roles.cache.has(roleId)`ã§ãƒ­ãƒ¼ãƒ«æ‰€å±ç¢ºèª

---

## 8. å‚è€ƒæƒ…å ±

### APIãƒ»SDKé–¢é€£

- [OpenRouter API Documentation](https://openrouter.ai/docs) - ãƒ¡ã‚¤ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆãƒãƒ£ãƒƒãƒˆã€ãƒ¢ãƒ‡ãƒ«ã€ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã€ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«ãªã©ï¼‰
- [OpenRouter TypeScript SDK](https://www.npmjs.com/package/@openrouter/sdk) - å…¬å¼TypeScript SDKï¼ˆå‹å®‰å…¨ãªAPIå‘¼ã³å‡ºã—ï¼‰
- [discord.js v14 Documentation](https://discord.js.org/docs/packages/discord.js/14.16.3) - ç¾åœ¨ä½¿ç”¨ä¸­ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [discord.js Guide](https://discordjs.guide/) - åˆå¿ƒè€…å‘ã‘ã‚¬ã‚¤ãƒ‰ï¼ˆã‚³ãƒãƒ³ãƒ‰ã€ã‚¤ãƒ™ãƒ³ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ï¼‰

### ã‚¤ãƒ³ãƒ•ãƒ©ãƒ»ãƒ„ãƒ¼ãƒ«é–¢é€£

- [GitHub Webhook Events](https://docs.github.com/en/webhooks/webhook-events-and-payloads) - Webhookç½²åæ¤œè¨¼ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
- [Bun Runtime](https://bun.sh/docs) - JavaScript/TypeScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼ˆHTTPã€SQLiteã€ãƒ†ã‚¹ãƒˆãªã©ï¼‰

### å®Ÿè£…æ™‚ã«å½¹ç«‹ã¤ãƒªã‚½ãƒ¼ã‚¹

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- OpenRouterã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰: 400ï¼ˆBad Requestï¼‰ã€401ï¼ˆUnauthorizedï¼‰ã€402ï¼ˆInsufficient Creditsï¼‰ã€403ï¼ˆModerationï¼‰ã€408ï¼ˆTimeoutï¼‰ã€429ï¼ˆRate Limitï¼‰ã€500/502/503ï¼ˆModel Unavailableï¼‰

**ãƒ¬ãƒ¼ãƒˆåˆ¶é™**:

- Discord API: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾— 50å›/ç§’ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ 5å›/5ç§’
- OpenRouter: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«åˆ¶é™ï¼ˆå…¨ãƒ¢ãƒ‡ãƒ«ï¼‰ã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ¬ãƒ™ãƒ«åˆ¶é™ï¼ˆç‰¹å®šãƒ¢ãƒ‡ãƒ«ï¼‰ã®2ç¨®é¡

**Discordåˆ¶é™**:

- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é•·: 2000æ–‡å­—
- Embed description: 4096æ–‡å­—
- Embedæ•°: 10å€‹/ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- ãƒœã‚¿ãƒ³æ•°: 5å€‹/ActionRowã€æœ€å¤§5è¡Œï¼ˆåˆè¨ˆ25å€‹ï¼‰
